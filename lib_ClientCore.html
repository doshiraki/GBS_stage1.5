<script>
/**
 * ðŸª„ RPC Proxy Override (ClientCore Module)
 * google.script.run ã‚’ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã—ã¦ RPC ã‚¹ã‚¿ã‚¤ãƒ«ã«å¤‰æ›ã™ã‚‹ã‚ˆã€‚
 * LoaderãŒä½¿ã† .run() ã¯ãã®ã¾ã¾é€šã™ã®ãŒãƒã‚¤ãƒ³ãƒˆï¼
 */
(function() {
  const createHijackedRunner = (realRunner) => {
    return new Proxy(realRunner, {
      get: (target, prop) => {
        // ðŸ›‘ Stop Infinite Loop!
        if (prop === 'run') {
          return target[prop];
        }

        // Pattern A: ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ (withSuccessHandler, etc.)
        // ãƒã‚§ãƒ¼ãƒ³ãŒç¶šãé™ã‚Šã€æ¬¡ã®Runnerã‚‚Proxyã§åŒ…ã¿ç›´ã™
        if (['withSuccessHandler', 'withFailureHandler', 'withUserObject'].includes(prop)) {
          return (arg) => {
            const nextRealRunner = target[prop](arg);
            return createHijackedRunner(nextRealRunner);
          };
        }

        // Pattern B: é€šå¸¸ã®é–¢æ•°å‘¼ã³å‡ºã— (å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼)
        // ðŸš€ ã“ã“ã§ Promise åŒ–ã‚’è¡Œã†ï¼
        return (...args) => target.run("func", [prop, ...args]);             // ã‚µãƒ¼ãƒãƒ¼å´ã® Dispatcher 'run' ã‚’å‘¼ã¶
      }
    });
  };

  // ðŸš€ Ignition
  google.script.run = createHijackedRunner(google.script.run);
})();

const ClientCore = {
  injectHtml(content, rootElement) {
    const range = document.createRange();
    range.selectNode(document.body);
    const fragment = range.createContextualFragment(content);
    rootElement.appendChild(fragment);
    fragment.querySelectorAll('script').forEach(old => {
      const neu = document.createElement('script');
      Array.from(old.attributes).forEach(a => neu.setAttribute(a.name, a.value));
      neu.text = old.innerHTML;
      old.parentNode.replaceChild(neu, old);
    });
  },

  async boot(config, loader, ui) {
    try {
      if (config.dependencies.length > 0) {
        ui.status.textContent = 'Loading Drivers...';
        await Promise.all(config.dependencies.map(lib => loader.load(lib, true, true)));
      }

      ui.status.textContent = 'Loading App...';
      const mainHtml = await loader.load(config.targetMain, true, false);

      ui.status.textContent = 'Rendering...';
      this.injectHtml(mainHtml, ui.root);

      ui.loader.style.opacity = '0';
      setTimeout(() => {
        ui.loader.style.display = 'none';
        ui.root.style.display = 'block';
        window.GBS = loader;
        window.dispatchEvent(new Event('gbs-loaded'));
        document.dispatchEvent(new Event('DOMContentLoaded'));
        window.dispatchEvent(new Event('load'));
      }, 400);

    } catch (err) {
      throw err;
    }
  }
};
</script>